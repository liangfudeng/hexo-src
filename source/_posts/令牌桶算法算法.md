---
title: 基于DPDK的多核令牌桶算法
categories: 网络转发
tags:
  - 网络转发
  - 令牌桶算法
  - 多核限速
  - DPDK
---

QoS（Quality of Service，服务质量）指一个网络能够利用各种基础技术，为指定的网络通信提供更好的服务能力, 是网络的一种安全机制， 是用来解决网络延迟和阻塞等问题的一种技术。其中限速就是一种QOS机制，目前限速算法中用得比较多的是令牌桶算法。本文不打算套路目前有哪些限速算法，而主要套路基于DPDK的软件架构，如何实现多核限速算法，并获取到较高的性能。

# 令牌桶算法介绍
## 简介

所谓的令牌桶算法，顾名思义，就是向一个桶中按照一定的速率放入令牌，如下图所示。当有需要限速的数据包通过的时候，依据数据报文的长度算出需要取走的令牌数N。如果桶中的令牌数量大于N，那么此数据包就顺利通过了限速测试。反之，此数据包就没有通过限速测试，于是就将报文进行丢弃处理（大多数情况下是如此，也可以进行其他处理，依赖用户程序的设计）。整个令牌桶算法的主要原理就是这样，是不是感觉很简单，详细分析将在下文介绍。
{% img /images/lingpaitong.PNG 800 700 %}

## 基于DPDK的实现
首先介绍下DPDK的两个函数，这也是在算法的实现中需要用到的两个函数，摘抄自DPDK官方文档：
```
static uint64_t rte_get_timer_cycles(void )
Get the number of cycles since boot from the default timer.

static uint64_t rte_get_timer_hz(void)
Get the number of cycles in one second for the default timer.	

```

### 放入令牌
在本设计中，以N = rte_get_timer_hz() 的速率向桶里面放令牌。也就是说，每秒放入一秒的时钟周期个数的令牌。的限速rate = 10000Bps，需要限速的包的大小为1500B。那么在处理该数据包，应该消耗多少令牌呢？利用小学数学应该可以算出，需要消耗
```
如果一秒内有一个包：
N * (1500 / 10000) < N 此时可以通过
如果一秒内有7个包
N * (1500*7 / 10000) > N 那么第七个包将会被丢弃

```
### 放入方式
假设每秒应该放入N = rte_get_timer_hz() 个令牌
* 方式1： 设置定时器，在定时器的回调函数中放入令牌。
	* 解析： 可以利用dpdk的定时器，比如设置每1秒，call以下回调函数，放入令牌1 * N个令牌。
	* 缺陷1： 这种方式的问题在于，如果在这一秒钟内，如果前0.5秒的突发流量将令牌都消耗完了，那么后0.5秒的报文不就全部丢掉了。有人说，可以将这个间隔设置小一点啊，比入每1/1000秒放入N/1000个令牌。但是问题在于，这个间隔到底是多少好呢？
	* 缺陷2： 无法处理突发流量，原因见方式3。


* 方式2： 按时间间隔放入
	* 解析： 按时间间隔放入，假设当前报文和上一个报文的时间间隔为1ms秒，那么放入1/1000 * N 个令牌。这种方式的好处在于针对于每个数据包的处理前都会放入令牌，分散了令牌的放入。
	* 缺陷： 无法处理突发流量，原因见方式3。
	{% img /images/lingpaitong1.JPG %}

* 方式3： 改进方式2
	* 背景： 方式1和方式2都面临一个问题，如果有突发流量，那么可能在极短的时间内消耗全部的令牌，大量的流量被放行，从而对系统造成威胁。
	* 解析： 如果当出现丢包，那么在接下来的200us内的前64个报文都会被丢弃。对于200us和64这个值都是经验值，可以在真实场景中进行调优。
	* 缺陷： 这个方式降低了突发流量对系统的威胁，但是会对限速的准确性有一定的影响，通过测试可以证明。
	{% img /images/lingpaitong2.JPG %}

{% blockquote %}
** 方式2和方式3可以协作运行，比如用方式3先进行防攻击限速，然后再用方式2进行精确限速。**
{% endblockquote %}

### 多线程处理
** 多线程处理的基本思想，如下图所示：**
* 一个全局令牌桶
	随着时间的推移，每次放入令牌仅仅放入全局令牌桶。为什么不放入线程令牌桶？假设需要限速的报文到了不同的线程，并且每个线程流量不同，那么对于每个线程放入令牌的数量就不得而知了。
* 每个线程拥有独立的子令牌桶
	子令牌桶只消费令牌，不放入令牌。当子令牌桶的令牌不够时，从全局令牌桶索取令牌。

{% img /images/lptfp.PNG %}

** 详细流程 **
下面将用流程图的形式来描述多线程令牌桶的实现。在最后会介绍这种令牌桶算法可能存在的问题。
{% img /images/lingpaitong3.jpg %}

### 测试结果
设置限速11Mbps，测试结果为：
{% img /images/lingpaitong_rs.jpg %}
